name: End to end ðŸ¥š âž¡ï¸ ðŸ”

on:
  push:
    branches:
      - bugfix/fix-regression-on-vendormodules

env:
  # see https://github.com/composer/composer/issues/9368#issuecomment-718112361
  COMPOSER_ROOT_VERSION: dev-main

jobs:
  end-to-end:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    strategy:
      fail-fast: true
      matrix:
        include:
          - directory: e2e/basic-app
            php-version: 8.1
          - directory: e2e/basic-module
            php-version: 8.1
    steps:
      # Build source code
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          coverage: none

      - uses: ramsey/composer-install@v3

      # Downgrade to PHP 7.4
      - run: vendor/bin/rector process config rules src --config build/rector-downgrade-php-74.php --ansi --no-diffs

      # Copy composer
      - run: cp build/composer-php-74.json composer.json

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}

      # Reinstall to clear out any unwanted dependencies
      - run: rm -rf vendor composer.lock

      - uses: ramsey/composer-install@v3
        with:
          dependency-versions: highest

      # Set up e2e directory
      - uses: ramsey/composer-install@v3
        with:
          working-directory: ${{ matrix.directory }}

      # Run rector on the e2e directory
      - run: vendor/bin/rector process --dry-run --ansi --output-format json >> output.txt
        working-directory: ${{ matrix.directory }}
        continue-on-error: true

      # Compare the actual output vs the expected
      - run: diff output.txt expected-output.txt
        working-directory: ${{ matrix.directory }}
